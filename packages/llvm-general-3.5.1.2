PKGID=llvm-general-3.5.1.2
TAR_URL=https://hackage.haskell.org/package/${PKGID}/${PKGID}.tar.gz
CABAL_INSTALL_OPTIONS=("--hsc2hs-option=--lflag=-Wl,-rpath,`ghc --print-libdir`" -fshared-llvm)

PRE() {
  local ctar_url=http://releases.llvm.org/3.5.1/llvm-3.5.1.src.tar.xz
  local ctar_fname=${tmpdir}/`basename ${ctar_url}`
  local libdir=`ghc --print-libdir`
  local library=`dirname "${libdir}"`
  local library=`dirname "${library}"`
  local library=`dirname "${library}"`
  local prefix=${library}/${PKGID}
  # FIXME: maybe rather put prefix in /tmp if we copy the stuff anyway
  local llvm_config_args="--enable-targets=host --enable-shared --enable-optimized --enable-bindings=none \
                         --disable-docs --disable-clang-static-analyzer --disable-clang-arcmt"
  curl ${ctar_url} -o ${ctar_fname}     || exit 1
  tar -C ${tmpdir} -xf ${ctar_fname}    || exit 1
 
# Remove comment 
#  (cd ${tmpdir}/llvm-3.5.1.src; (./configure --prefix="${prefix}" ${llvm_config_args} && make && make install))
  
  ditto "${prefix}/bin"     "${libdir}/${PKGID}/bin"
  ditto "${prefix}/include" "${libdir}/${PKGID}/include"
  ditto "${prefix}/lib"     "${libdir}/${PKGID}/lib"
  ditto "${prefix}/share"   "${libdir}/${PKGID}/share"
  
  # Make sure the rest of the build uses our 'llvm-config'  
  export PATH="${libdir}/${PKGID}/bin:${PATH}"
}

POST() {
  local libdir=`ghc --print-libdir`
  
  # RPATH for the Haskell library to find the C++ library
  install_name_tool -add_rpath "@loader_path/lib" "${libdir}/${PKGID}/libHS${PKGID}"*.dylib
}

# NB: will implicitly install utf8-string